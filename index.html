<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Gadgethub Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">

  <!-- Your main content -->
  <div class="p-8">
    <h1 class="text-2xl font-bold">Welcome to Gadgethub Chat!</h1>
    <p>This is where your main content would go.</p>
  </div>

  <!-- Floating chat box UI -->
  <div id="chatBox" class="fixed bottom-4 right-4 z-50">
    <!-- Toggle Button -->
    <button id="chatToggle" class="bg-blue-500 text-white p-3 rounded-full shadow">
      ðŸ’¬
    </button>

    <!-- Chat Window -->
    <div id="chatWindow" class="hidden bg-white w-80 h-96 border rounded-lg shadow-lg flex flex-col">
      <div class="p-3 bg-blue-500 text-white flex justify-between items-center">
        <span>Chat</span>
        <button id="closeChat">âœ–</button>
      </div>
      <div id="messages" class="flex-1 p-3 overflow-y-auto bg-gray-50 space-y-2"></div>
      <div class="p-3 border-t flex gap-2">
        <input id="chatInput" type="text" class="flex-1 border p-2 rounded" placeholder="Type a message..." />
        <button id="sendBtn" class="bg-blue-500 text-white px-3 py-2 rounded">Send</button>
      </div>
    </div>
  </div>

  <!-- Your working script -->
  <script type="module">
    (async () => {
      const { supabase } = window;

      const chatInput = document.getElementById("chatInput");
      const sendBtn = document.getElementById("sendBtn");
      const messages = document.getElementById("messages");
      const chatWindow = document.getElementById("chatWindow");
      const chatToggle = document.getElementById("chatToggle");
      const closeChat = document.getElementById("closeChat");

      let userId = null;

      const getUser = async () => {
        const { data: { user }, error } = await supabase.auth.getUser();
        if (user) userId = user.id;
        else console.error("User not logged in", error);
      };
      await getUser();

      async function sendMessage() {
        const messageText = chatInput.value.trim();
        if (messageText === '' || !userId) return;

        const { error } = await supabase.from("messages").insert([
          { message: messageText, sender_id: userId }
        ]);

        if (error) {
          console.error("Error sending message:", error.message);
          return;
        }

        // Add to UI
        const div = document.createElement("div");
        div.className = "text-right";
        div.innerHTML = `<div class="inline-block bg-blue-500 text-white px-4 py-2 rounded-lg shadow">${messageText}</div>`;
        messages.appendChild(div);
        chatInput.value = '';
        messages.scrollTop = messages.scrollHeight;
      }

      sendBtn.addEventListener("click", sendMessage);
      chatInput.addEventListener("keypress", e => {
        if (e.key === "Enter") sendMessage();
      });

      chatToggle.addEventListener("click", () => chatWindow.classList.toggle("hidden"));
      closeChat.addEventListener("click", () => chatWindow.classList.add("hidden"));

      supabase
        .channel('public:messages')
        .on('postgres_changes', {
          event: 'INSERT',
          schema: 'public',
          table: 'messages'
        }, payload => {
          const msg = payload.new;
          if (msg.sender_id !== userId) {
            const div = document.createElement("div");
            div.className = "text-left";
            div.innerHTML = `<div class="inline-block bg-white border px-4 py-2 rounded-lg shadow">${msg.message}</div>`;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
          }
        })
        .subscribe();
    })();
  </script>
</body>
</html>
